#!/bin/bash
set -e

echo "==========================================="
echo "ğŸš€ i3 æ¡Œé¢ç¯å¢ƒå¿«é€Ÿå®‰è£…è„šæœ¬"
echo "==========================================="

# 1. å®‰è£…æ¡Œé¢ç¯å¢ƒæ ¸å¿ƒç»„ä»¶
echo "ğŸ“¦ ç¬¬1æ­¥ï¼šå®‰è£…æ¡Œé¢ç¯å¢ƒæ ¸å¿ƒç»„ä»¶..."
sudo apt update
sudo apt install -y \
    i3 \
    polybar \
    picom \
    rofi \
    conky-all \
    pcmanfm \
    dunst \
    feh \
    arandr \
    lxappearance \
    xclip \
    xsel \
    fonts-jetbrains-mono \
    fonts-font-awesome \
    papirus-icon-theme \
    htop \
    git \
    curl \
    wget

echo "âœ… æ¡Œé¢ç¯å¢ƒç»„ä»¶å®‰è£…å®Œæˆï¼"

# 2. å®‰è£… Nix (ä½¿ç”¨ Determinate Systems å®‰è£…å™¨)
echo "ğŸ“¦ ç¬¬2æ­¥ï¼šå®‰è£… Nix åŒ…ç®¡ç†å™¨..."
if ! command -v nix &> /dev/null; then
    echo "æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… Nix..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
    echo 'source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' >> ~/.bashrc
    source /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    echo "âœ… Nix å®‰è£…å®Œæˆ"
else
    echo "âœ… Nix å·²å®‰è£…"
fi

# 3. ä» GitHub ä¸‹è½½é…ç½®ä»“åº“
echo "ğŸ“¥ ç¬¬3æ­¥ï¼šä¸‹è½½é…ç½®æ–‡ä»¶..."
CONFIG_DIR="$HOME/.config/home-manager"
GITHUB_REPO="https://github.com/YOUR_USERNAME/YOUR_REPO.git"  # è¯·æ›¿æ¢ä¸ºæ‚¨çš„ä»“åº“åœ°å€

if [ -d "$CONFIG_DIR" ]; then
    echo "âš ï¸  é…ç½®æ–‡ä»¶ç›®å½•å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸­..."
    cd "$CONFIG_DIR"
    git pull origin main
else
    echo "æ­£åœ¨å…‹éš†é…ç½®ä»“åº“..."
    git clone "$GITHUB_REPO" "$CONFIG_DIR"
    cd "$CONFIG_DIR"
fi

echo "âœ… é…ç½®æ–‡ä»¶ä¸‹è½½å®Œæˆ"

# 4. å¤åˆ¶ nix.conf é…ç½®æ–‡ä»¶
echo "âš™ï¸  ç¬¬4æ­¥ï¼šé…ç½® Nix..."
mkdir -p ~/.config/nix
if [ -f "$CONFIG_DIR/nix.conf" ]; then
    cp "$CONFIG_DIR/nix.conf" ~/.config/nix/nix.conf
    echo "âœ… nix.conf å·²å¤åˆ¶åˆ° ~/.config/nix/"
else
    echo "âš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ° nix.conf æ–‡ä»¶"
fi

# 5. æ£€æŸ¥å¹¶å®‰è£… Home Manager
echo "ğŸ  ç¬¬5æ­¥ï¼šå®‰è£… Home Manager..."
if ! command -v home-manager &> /dev/null; then
    echo "æ­£åœ¨å®‰è£… Home Manager..."
    nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    nix-channel --update
    export NIX_PATH=$HOME/.nix-defexpr/channels:/nix/var/nix/profiles/per-user/root/channels${NIX_PATH:+:$NIX_PATH}
    nix-shell '<home-manager>' -A install
    echo "âœ… Home Manager å®‰è£…å®Œæˆ"
else
    echo "âœ… Home Manager å·²å®‰è£…"
fi

# 6. åº”ç”¨ Home Manager é…ç½®
echo "ğŸ”§ ç¬¬6æ­¥ï¼šåº”ç”¨é…ç½®..."
cd "$CONFIG_DIR"
echo "å½“å‰ç›®å½•ï¼š$(pwd)"

if [ -f "flake.nix" ]; then
    echo "ä½¿ç”¨ flake é…ç½®..."
    home-manager switch --flake .#mzn
else
    echo "ä½¿ç”¨ä¼ ç»Ÿé…ç½®..."
    home-manager switch
fi

echo "==========================================="
echo "ğŸ‰ å®‰è£…å®Œæˆï¼"
echo ""
echo "ğŸ“‹ å·²å®‰è£…çš„è½¯ä»¶ï¼š"
echo "   â€¢ i3 çª—å£ç®¡ç†å™¨"
echo "   â€¢ Polybar çŠ¶æ€æ "
echo "   â€¢ Picom åˆæˆå™¨"
echo "   â€¢ Rofi åº”ç”¨å¯åŠ¨å™¨"
echo "   â€¢ Conky ç³»ç»Ÿç›‘è§†å™¨"
echo "   â€¢ PCManFM æ–‡ä»¶ç®¡ç†å™¨"
echo "   â€¢ Dunst é€šçŸ¥å®ˆæŠ¤è¿›ç¨‹"
echo "   â€¢ Nix åŒ…ç®¡ç†å™¨"
echo "   â€¢ Home Manager"
echo ""
echo "ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š"
echo "   1. æ³¨é”€å½“å‰ä¼šè¯"
echo "   2. åœ¨ç™»å½•ç®¡ç†å™¨ä¸­é€‰æ‹© 'i3'"
echo "   3. æˆ–è€…ä»ç»ˆç«¯è¿è¡Œ: startx"
echo ""
echo "âš™ï¸  é…ç½®æ–‡ä»¶ä½ç½®ï¼š"
echo "   ~/.config/home-manager/"
echo ""
echo "ğŸ”„ æ›´æ–°é…ç½®ï¼š"
echo "   cd ~/.config/home-manager"
echo "   git pull"
echo "   home-manager switch --flake .#mzn"
echo "==========================================="

# å¯é€‰ï¼šè¯¢é—®æ˜¯å¦é‡å¯æ˜¾ç¤ºç®¡ç†å™¨
read -p "æ˜¯å¦è¦é‡å¯æ˜¾ç¤ºç®¡ç†å™¨ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if pgrep lightdm > /dev/null; then
        sudo systemctl restart lightdm
    elif pgrep gdm3 > /dev/null; then
        sudo systemctl restart gdm3
    elif pgrep sddm > /dev/null; then
        sudo systemctl restart sddm
    else
        echo "è¯·æ‰‹åŠ¨æ³¨é”€å¹¶é‡æ–°ç™»å½•"
    fi
fi
